<div class="analyse-content">
  <div class="texture-layer"></div>

  <div class="analyse-shell">
    <section class="masthead">
      <div>
        <p class="kicker">Analyse Service Workspace</p>
        <h1>Negotiation Intelligence Studio</h1>
        <p class="lead">
          Upload one contract, extract redlines, compare against precedents, and review each change with decision actions.
        </p>
      </div>
      <div class="headline-stats">
        <div class="stat-pill">
          <span>Agreement Type</span>
          <strong>{{ getContractType() }}</strong>
        </div>
        <div class="stat-pill">
          <span>Redlines</span>
          <strong>{{ getSummaryCount('redlines_analyzed') }}</strong>
        </div>
        <div class="stat-pill">
          <span>Status</span>
          <strong>{{ currentStatus || 'idle' }}</strong>
        </div>
      </div>
    </section>

    <section class="workspace-grid">
      <div class="left-zone">
        <article class="card upload-card">
          <div class="config-top">
            <h3>Document Input</h3>
            <button class="btn-ghost" (click)="fetchHistory()">Refresh History</button>
          </div>
          <p class="muted">Upload a DOCX with clean text or tracked redlines.</p>
          <input type="file" [class.invalid]="submitted && !!formErrors.docxFile" accept=".docx" (change)="onDocxFileChange($event)" />
          <div class="field-error" *ngIf="submitted && formErrors.docxFile">{{ formErrors.docxFile }}</div>
          <p class="file-meta" *ngIf="docxFile">{{ docxFile.name }}</p>
          <button class="btn-primary" (click)="runAnalysis()" [disabled]="isSubmitting">
            {{ isSubmitting ? 'Submitting...' : 'Start Analysis' }}
          </button>
        </article>

        <article class="card job-card" *ngIf="jobId">
          <div class="job-head">
            <h3>Job Timeline</h3>
            <span class="status-chip" [ngClass]="statusClass(currentStatus)">{{ currentStatus || 'queued' }}</span>
          </div>
          <p class="job-id">Job ID: {{ jobId }}</p>
          <ul class="progress-list">
            <li *ngFor="let item of progress">{{ item }}</li>
          </ul>
        </article>

        <article class="card metrics-card" *ngIf="analysisResult">
          <h3>Document Signals</h3>
          <div class="metric-grid">
            <div class="metric-box">
              <span>Tracked Changes</span>
              <strong>{{ getDocumentStat('tracked_changes') }}</strong>
            </div>
            <div class="metric-box">
              <span>Comments</span>
              <strong>{{ getSummaryCount('comments_found') }}</strong>
            </div>
            <div class="metric-box">
              <span>Additions</span>
              <strong>{{ getSummaryCount('additions') }}</strong>
            </div>
            <div class="metric-box">
              <span>Strikeouts</span>
              <strong>{{ getSummaryCount('strikeouts') }}</strong>
            </div>
            <div class="metric-box">
              <span>Precedents</span>
              <strong>{{ getSummaryCount('document_level_precedents') }}</strong>
            </div>
            <div class="metric-box">
              <span>Confidence</span>
              <strong>{{ getDocumentStat('extraction_confidence') | number:'1.2-2' }}</strong>
            </div>
          </div>
        </article>

        <article class="card precedent-card" *ngIf="analysisResult">
          <h3>Top Precedent Evidence</h3>
          <p class="muted" *ngIf="!getPrecedentCitations().length">No precedent citations returned.</p>
          <div class="citation-list" *ngIf="getPrecedentCitations().length">
            <div class="citation-item" *ngFor="let c of getPrecedentCitations(); let i = index">
              <div class="citation-head">
                <strong>#{{ i + 1 }} {{ c['filename'] || 'Unknown File' }}</strong>
                <span>Score {{ (c['score'] || 0) | number:'1.3-3' }}</span>
              </div>
              <p>{{ c['text'] || '-' }}</p>
            </div>
          </div>
        </article>
      </div>

      <aside class="right-zone">
        <article class="card redline-card">
          <div class="redline-head">
            <h3>Redline Navigator</h3>
            <span>{{ getRedlineInsights().length }} changes</span>
          </div>

          <p class="muted" *ngIf="!getRedlineInsights().length">
            Run analysis to view redline-by-redline guidance.
          </p>

          <div class="redline-list" *ngIf="getRedlineInsights().length">
            <button
              type="button"
              class="redline-item"
              *ngFor="let item of getRedlineInsights()"
              [class.active]="item.index === selectedRedlineIndex"
              (click)="selectRedline(item.index)">
              <div class="redline-row">
                <span class="tag">#{{ item.index }} {{ item.type }}</span>
                <span class="decision" [ngClass]="decisionClass(item.index)">{{ decisionLabel(item.index) }}</span>
              </div>
              <p>{{ item.text }}</p>
              <small>{{ item.sectionTitle }}</small>
            </button>
          </div>

          <div class="review-panel" *ngIf="getSelectedRedline() as selected">
            <h4>Selected Redline</h4>
            <p class="review-topic">{{ selected.sectionTitle }} â€¢ {{ selected.legalTopic }}</p>
            <p class="review-text">{{ selected.text }}</p>
            <p class="review-intent"><strong>Intent:</strong> {{ selected.intent }}</p>
            <p class="review-intent"><strong>Suggested:</strong> {{ selected.suggestedResponse }}</p>

            <div class="action-row">
              <button class="btn-accept" (click)="decide('accept')">Accept</button>
              <button class="btn-reject" (click)="decide('reject')">Reject</button>
              <button class="btn-edit" (click)="decide('edit')">Edit</button>
            </div>

            <label class="editor-label">
              Edit text
              <textarea rows="4" [(ngModel)]="redlineEditorText"></textarea>
            </label>
            <button class="btn-primary" (click)="saveEditedText()">Save Edited Text</button>
          </div>
        </article>
      </aside>
    </section>

    <section class="card history-card">
      <h3>Analysis History</h3>
      <p class="muted" *ngIf="!analysisHistory.length">No analysis jobs yet.</p>
      <div class="history-list" *ngIf="analysisHistory.length">
        <article class="history-item" *ngFor="let item of analysisHistory">
          <div class="history-top">
            <strong>{{ item.input?.file_name || 'Unknown file' }}</strong>
            <span class="status-chip" [ngClass]="statusClass(item.status)">{{ item.status }}</span>
          </div>
          <p class="history-meta">Job: {{ item.job_id }}</p>
          <p class="history-meta">Created: {{ item.created_at | date:'medium' }}</p>
          <p class="history-meta">Updated: {{ item.updated_at | date:'medium' }}</p>
          <p class="history-meta">Mode: {{ item.input?.version_mode || 'latest' }} | top_k: {{ item.input?.top_k || '-' }}</p>
          <p class="history-error" *ngIf="item.error">{{ item.error }}</p>
        </article>
      </div>
    </section>

    <div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>
  </div>
</div>
